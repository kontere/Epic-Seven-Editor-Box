<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ma Box Epic Seven — Online</title>
<meta name="description" content="Gère ta box Epic Seven en ligne : ajout rapide de héros, stats, et artefacts. Catalogues depuis data/*.json du repo.">
<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b; --muted:#94a3b8; --text:#e2e8f0;
    --accent:#60a5fa; --accent-2:#34d399; --border:#233047; --danger:#ef4444; --yellow:#fbbf24;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--text);
    background: radial-gradient(1200px 800px at 10% 10%, #0b1220 10%, var(--bg1) 30%, var(--bg2));
    min-height:100vh;
  }
  a{color:#bfdbfe}
  header{ padding:28px 18px 12px; }
  .wrap{ max-width:1200px; margin:0 auto; padding:0 16px 60px; }
  h1{ margin:0 0 6px; font-size: clamp(24px, 4vw, 36px); letter-spacing:.5px; }
  .sub{ color:var(--muted); margin: 0 0 14px; }
  .status{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0b1220; color:#cbd5e1; }
  .chip.ok{ border-color: rgba(52,211,153,.5); color:#86efac; }
  .chip.warn{ border-color: rgba(251,191,36,.5); color:#fde68a; }
  .chip.err{ border-color: rgba(239,68,68,.5); color:#fecaca; }

  /* Form above listing */
  .form{
    margin-top:16px; border:1px solid var(--border); border-radius:16px; padding:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
  }
  .form h2{ margin:0 0 10px; font-size:18px; color:#bfdbfe; }
  .form-grid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
  .form-grid input{ background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; width:100%; }
  .form-actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
  .btn{ border:1px solid var(--accent); color: var(--accent); background:#0b1220; border-radius:10px; padding:10px 12px; cursor:pointer; }
  .danger{ border-color: var(--danger); color: var(--danger); }
  .save{ border-color: var(--accent-2); color: var(--accent-2); }

  /* Controls row */
  .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; margin-top:16px; }
  .controls input, .controls select, .controls button{
    background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none;
  }

  .grid{ margin-top:12px; width:100%; overflow:auto; border:1px solid var(--border); border-radius:16px; }
  table{ width:100%; border-collapse:separate; border-spacing:0; background: rgba(11,18,32,.6); }
  thead th{
    position:sticky; top:0; background:#0b1220; z-index:1; color:#cbd5e1; font-weight:700; text-align:left; padding:12px;
    border-bottom:1px solid var(--border); white-space:nowrap; cursor:pointer;
  }
  tbody td{ border-top:1px solid var(--border); padding:10px 12px; vertical-align:middle; }
  tr:hover td{ background: rgba(96,165,250,.06); }
  .hero{ display:flex; align-items:center; gap:10px; }
  .avatar{
    width:36px;height:36px;border-radius:50%; display:inline-flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#081225;font-weight:800;
    overflow:hidden;border:1px solid rgba(255,255,255,.2); flex:0 0 36px;
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .badges{ display:flex; gap:6px; flex-wrap:wrap; }
  .badge{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1; background:#0b1220; white-space:nowrap; }
  .pill{ background:rgba(52,211,153,.12); border-color:rgba(52,211,153,.4); color:#86efac; }

  /* Pickers */
  .picker{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.55); align-items:flex-start; justify-content:center; padding-top:8vh; }
  .picker.open{ display:flex; }
  .picker-card{ width:min(1000px, 95vw); max-height:80vh; overflow:auto; background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:16px; }
  .row{ display:flex; gap:8px; align-items:center; margin-bottom:10px; }
  .picker-grid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; }
  .opt{ display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--border); border-radius:12px; cursor:pointer; }
  .opt:hover{ border-color: var(--accent); }
  .opt img{ width:40px; height:40px; border-radius:10px; object-fit:cover; }
  .close{ margin-left:auto; cursor:pointer; border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#0b1220; color:#e2e8f0; }
</style>
</head>
<body>
<header class="wrap">
  <h1>Ma Box Epic Seven</h1>
  <div class="sub">Les catalogues proviennent de <code>data/heroes.json</code> & <code>data/artifacts.json</code>. Ta box personnelle est sauvegardée dans le navigateur.</div>

  <div class="status">
    <span id="hStatus" class="chip">Héros : …</span>
    <span id="aStatus" class="chip">Artefacts : …</span>
  </div>

  <!-- Quick add form ABOVE the listing -->
  <section class="form">
    <h2>＋ Ajouter / modifier un héros</h2>
    <div class="form-grid">
      <input id="f_nom" placeholder="Nom du héros *" />
      <input id="f_art" placeholder="Artefact" />
      <input id="f_elem" placeholder="Élément (Feu, Glace, Terre, Ténèbres, Lumière)" />
      <input id="f_class" placeholder="Classe (Guerrier, Voleur, Rôdeur, Chevalier, Mage, Tisseuse d'âme)" />
      <input id="f_pc" type="number" placeholder="Puissance (PC)" />
      <input id="f_atk" type="number" placeholder="ATK" />
      <input id="f_def" type="number" placeholder="DEF" />
      <input id="f_pv" type="number" placeholder="PV" />
      <input id="f_spd" type="number" placeholder="SPD" />
      <input id="f_cc" type="number" placeholder="% Crit" />
      <input id="f_cd" type="number" placeholder="% Dégâts Crit" />
      <input id="f_eff" type="number" placeholder="% Efficacité" />
      <input id="f_er" type="number" placeholder="% Résistance" />
      <input id="f_set1" placeholder="Set principal" />
      <input id="f_set2" placeholder="Set secondaire" />
      <input id="f_avatar" placeholder="URL Avatar (auto si nom reconnu)" />
    </div>
    <div class="form-actions">
      <button class="btn" id="pickHero">Choisir un héros</button>
      <button class="btn" id="pickArtifact">Choisir un artefact</button>
      <button class="btn save" id="add">Ajouter / Mettre à jour</button>
      <button class="btn danger" id="delete">Supprimer ce héros</button>
    </div>
  </section>

  <!-- Controls -->
  <div class="controls">
    <input id="q" placeholder="Filtrer (nom, élément, classe, artefact, set…)" />
    <select id="el">
      <option value="">— Élément (tous) —</option>
      <option>Feu</option><option>Eau</option><option>Terre</option><option>Ténèbres</option><option>Lumière</option>
    </select>
  <select id="cls">
    <option value="">— Classe (toutes) —</option>
    <option>Guerrier</option><option>Voleur</option><option>Rôdeur</option><option>Chevalier</option><option>Mage</option><option>Tisseuse d'âme</option>
  </select>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button class="btn" id="export">Exporter JSON (ma box)</button>
      <button class="btn save" id="save">Sauvegarder</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <table id="tbl">
      <thead>
        <tr>
          <th data-k="Nom">Héros</th>
          <th data-k="Pc">Puissance</th>
          <th data-k="Attaque">ATK</th>
          <th data-k="Défense">DEF</th>
          <th data-k="PV">PV</th>
          <th data-k="Vitesse">SPD</th>
          <th data-k="Taux Crit">%CC</th>
          <th data-k="Dégâts Crit">%CD</th>
          <th data-k="Efficacité">%Eff</th>
          <th data-k="Résistance">%ER</th>
          <th data-k="Set principal">Set 1</th>
          <th data-k="Set secondaire">Set 2</th>
          <th data-k="Artefact">Artefact</th>
          <th data-k="__actions">Actions</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</main>

<!-- HERO PICKER -->
<div class="picker" id="heroPicker">
  <div class="picker-card">
    <div class="row">
      <h3>Choisir un héros</h3>
      <button class="close" data-close="#heroPicker">Fermer</button>
    </div>
    <div class="row">
      <input id="heroSearch" placeholder="Rechercher un héros…" style="flex:1;background:#0b1220;color:#e2e8f0;border:1px solid var(--border);border-radius:10px;padding:10px;">
    </div>
    <div class="picker-grid" id="heroGrid"></div>
  </div>
</div>

<!-- ARTIFACT PICKER -->
<div class="picker" id="artifactPicker">
  <div class="picker-card">
    <div class="row">
      <h3>Choisir un artefact</h3>
      <button class="close" data-close="#artifactPicker">Fermer</button>
    </div>
    <div class="row">
      <input id="artifactSearch" placeholder="Rechercher un artefact…" style="flex:1;background:#0b1220;color:#e2e8f0;border:1px solid var(--border);border-radius:10px;padding:10px;">
    </div>
    <div class="picker-grid" id="artifactGrid"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function initials(name){ return (name||"??").split(/\s+/).slice(0,2).map(w=>w[0]).join('').toUpperCase(); }
function num(x){ const v = parseFloat(String(x).replace(/[^0-9.-]/g,'')); return isNaN(v)? null : v; }

const STORAGE_KEY = "e7_box_data_online";
let data = [];
try{ data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }catch(e){ data = []; }

let HERO_OPTS = [];
let ART_OPTS = [];
const MIN_HEROES = 364;
const MIN_ARTS = 259;

async function fetchJson(u){ const r = await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error("HTTP "+r.status+" for "+u); return r.json(); }

async function loadCatalog(){
  try{
    const [h,a] = await Promise.all([ fetchJson("data/heroes.json"), fetchJson("data/artifacts.json") ]);
    HERO_OPTS = Array.isArray(h.heroes)? h.heroes : [];
    ART_OPTS  = Array.isArray(a.artifacts)? a.artifacts : [];
  }catch(e){
    console.error(e);
    HERO_OPTS = []; ART_OPTS = [];
  }
  const hs = $("#hStatus"), as = $("#aStatus");
  hs.textContent = `Héros : ${HERO_OPTS.length}`;
  as.textContent = `Artefacts : ${ART_OPTS.length}`;
  hs.className = "chip " + (HERO_OPTS.length>=MIN_HEROES ? "ok" : HERO_OPTS.length? "warn":"err");
  as.className = "chip " + (ART_OPTS.length>=MIN_ARTS ? "ok" : ART_OPTS.length? "warn":"err");
}

let sortKey="Nom", sortDir=1;
function render(){
  const q = $("#q").value.toLowerCase().trim();
  const el = $("#el").value;
  const cls = $("#cls").value;
  const body = $("#body");
  body.innerHTML = "";

  let rows = data.filter(it=>{
    const blob = [it.Nom, it.Élément, it.Classe, it.Artefact, it["Set principal"], it["Set secondaire"]].join(" ").toLowerCase();
    const matchQ = !q || blob.includes(q);
    const matchEl = !el || (it.Élément||"").toLowerCase().includes(el.toLowerCase());
    const matchCls = !cls || (it.Classe||"").toLowerCase().includes(cls.toLowerCase());
    return matchQ && matchEl && matchCls;
  });

  rows.sort((a,b)=>{
    const na = num(a[sortKey]); const nb = num(b[sortKey]);
    if (na!=null && nb!=null) return (na-nb)*sortDir;
    const va = (a[sortKey] ?? "").toString().toLowerCase();
    const vb = (b[sortKey] ?? "").toString().toLowerCase();
    if (va<vb) return -1*sortDir; if (va>vb) return 1*sortDir; return 0;
  });

  for (const it of rows){
    const tr = document.createElement("tr");
    const img = it.avatar ? `<img src="${it.avatar}" alt="${it.Nom}" onerror="this.parentNode.textContent='${initials(it.Nom)}'; this.remove();" />` : "";
    const avatar = `<div class="avatar">${ img || initials(it.Nom) }</div>`;
    const nameHtml = it.link ? `<a href="${it.link}" target="_blank" rel="noopener noreferrer">${it.Nom||""}</a>` : (it.Nom||"");
    const artHtml  = it.artifact_link ? `<a href="${it.artifact_link}" target="_blank" rel="noopener noreferrer">${it.Artefact||""}</a>` : (it.Artefact||"");
    tr.innerHTML = `
      <td>
        <div class="hero">
          ${avatar}
          <div>
            <div><strong>${nameHtml}</strong></div>
            <div class="badges">
              ${it.Élément? `<span class="badge">${it.Élément}</span>`:""}
              ${it.Classe? `<span class="badge pill">${it.Classe}</span>`:""}
            </div>
          </div>
        </div>
      </td>
      <td>${it.Pc??""}</td>
      <td>${it.Attaque??""}</td>
      <td>${it["Défense"]??""}</td>
      <td>${it.PV??""}</td>
      <td>${it.Vitesse??""}</td>
      <td>${it["Taux Crit"]??""}</td>
      <td>${it["Dégâts Crit"]??""}</td>
      <td>${it.Efficacité??""}</td>
      <td>${it.Résistance??""}</td>
      <td>${it["Set principal"]||""}</td>
      <td>${it["Set secondaire"]||""}</td>
      <td>${artHtml}</td>
      <td><button class="btn danger" data-del="${(it.Nom||'').replace('"','&quot;')}">Supprimer</button></td>
    `;
    tr.addEventListener("click", (ev)=>{
      if (ev.target && ev.target.dataset && ev.target.dataset.del) return;
      $("#f_nom").value = it.Nom||"";
      $("#f_pc").value = it.Pc??"";
      $("#f_atk").value = it.Attaque??"";
      $("#f_def").value = it["Défense"]??"";
      $("#f_pv").value = it.PV??"";
      $("#f_spd").value = it.Vitesse??"";
      $("#f_cc").value = it["Taux Crit"]??"";
      $("#f_cd").value = it["Dégâts Crit"]??"";
      $("#f_eff").value = it.Efficacité??"";
      $("#f_er").value = it.Résistance??"";
      $("#f_set1").value = it["Set principal"]||"";
      $("#f_set2").value = it["Set secondaire"]||"";
      $("#f_art").value = it.Artefact||"";
      $("#f_elem").value = it.Élément||"";
      $("#f_class").value = it.Classe||"";
      $("#f_avatar").value = it.avatar||"";
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    });
    tr.querySelector("[data-del]")?.addEventListener("click", (e)=>{
      e.stopPropagation();
      const name = e.target.getAttribute("data-del");
      if (confirm(`Supprimer ${name} ?`)){
        const idx = data.findIndex(x=> (x.Nom||"").toLowerCase() === name.toLowerCase());
        if (idx>=0){ data.splice(idx,1); render(); }
      }
    });
    body.appendChild(tr);
  }
}

// Sorting handlers
$$("thead th").forEach(th=>{
  th.addEventListener("click", ()=>{
    const k = th.dataset.k;
    if (sortKey === k){ sortDir *= -1; } else { sortKey = k; sortDir = 1; }
    render();
  });
});

// Filters & buttons
$("#q").addEventListener("input", render);
$("#el").addEventListener("change", render);
$("#cls").addEventListener("change", render);

// Add / Update
$("#add").addEventListener("click", ()=>{
  const item = {
    Nom: $("#f_nom").value.trim(),
    Pc: num($("#f_pc").value),
    Attaque: num($("#f_atk").value),
    "Défense": num($("#f_def").value),
    PV: num($("#f_pv").value),
    Vitesse: num($("#f_spd").value),
    "Taux Crit": num($("#f_cc").value),
    "Dégâts Crit": num($("#f_cd").value),
    Efficacité: num($("#f_eff").value),
    Résistance: num($("#f_er").value),
    "Set principal": $("#f_set1").value.trim(),
    "Set secondaire": $("#f_set2").value.trim(),
    Artefact: $("#f_art").value.trim(),
    Élément: $("#f_elem").value.trim(),
    Classe: $("#f_class").value.trim(),
    avatar: $("#f_avatar").value.trim(),
    link: "", artifact_link: "", artifact_icon: ""
  };
  if (!item.Nom){ alert("Le nom du héros est obligatoire."); return; }
  // Auto link depuis catalogues statiques
  const hero = HERO_OPTS.find(h => h.name.toLowerCase() === item.Nom.toLowerCase());
  if (hero){ item.link = hero.link; item.avatar = item.avatar || hero.img; }
  const art = ART_OPTS.find(a => a.name.toLowerCase() === item.Artefact.toLowerCase());
  if (art){ item.artifact_link = art.link; item.artifact_icon = art.img; }

  const idx = data.findIndex(x=> (x.Nom||"").toLowerCase() === item.Nom.toLowerCase());
  if (idx>=0) data[idx] = item; else data.push(item);
  render();
});

// Delete from form
$("#delete").addEventListener("click", ()=>{
  const name = ($("#f_nom").value||"").trim();
  if (!name){ alert("Sélectionne d'abord un héros (clique une ligne)."); return; }
  if (!confirm(`Supprimer ${name} ?`)) return;
  const idx = data.findIndex(x=> (x.Nom||"").toLowerCase() === name.toLowerCase());
  if (idx>=0){
    data.splice(idx,1);
    ["f_nom","f_pc","f_atk","f_def","f_pv","f_spd","f_cc","f_cd","f_eff","f_er","f_set1","f_set2","f_art","f_elem","f_class","f_avatar"].forEach(id=>{ const el=$("#"+id); if (el) el.value=""; });
    render();
  }
});

// Save / Export
$("#save").addEventListener("click", ()=>{
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("Sauvegardé dans le navigateur (localStorage)."); }
  catch(e){ alert("Échec de sauvegarde. Vérifie le stockage du navigateur."); }
});
$("#export").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "epic7_box_export.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Pickers
function openPicker(id){ $(id).classList.add("open"); }
function closePicker(id){ $(id).classList.remove("open"); }
$$(".close").forEach(btn=> btn.addEventListener("click", ()=>{ closePicker(btn.getAttribute("data-close")); }));

function fillGrid(gridSel, list, pickerSel, kind){
  const grid = document.querySelector(gridSel); grid.innerHTML = "";
  const term = (kind==="hero" ? document.querySelector("#heroSearch").value : document.querySelector("#artifactSearch").value).toLowerCase();
  list.filter(x => !term || x.name.toLowerCase().includes(term)).forEach(x=>{
    const div = document.createElement("div");
    div.className = "opt";
    div.innerHTML = `<img src="${x.img}" alt="${x.name}" onerror="this.style.display='none'"><div><div><strong>${x.name}</strong></div><div style='font-size:12px;color:#94a3b8'>${x.slug}</div></div>`;
    div.addEventListener("click", ()=>{
      if (kind==="hero"){
        $("#f_nom").value = x.name;
        $("#f_avatar").value = x.img;
      } else {
        $("#f_art").value = x.name;
      }
      closePicker(pickerSel);
    });
    grid.appendChild(div);
  });
}

$("#pickHero").addEventListener("click", ()=>{ $("#heroSearch").value=""; fillGrid("#heroGrid", HERO_OPTS, "#heroPicker", "hero"); openPicker("#heroPicker"); });
$("#pickArtifact").addEventListener("click", ()=>{ $("#artifactSearch").value=""; fillGrid("#artifactGrid", ART_OPTS, "#artifactPicker", "artifact"); openPicker("#artifactPicker"); });
document.getElementById("heroSearch").addEventListener("input", ()=> fillGrid("#heroGrid", HERO_OPTS, "#heroPicker", "hero"));
document.getElementById("artifactSearch").addEventListener("input", ()=> fillGrid("#artifactGrid", ART_OPTS, "#artifactPicker", "artifact"));

// Boot
(async function boot(){
  await loadCatalog();
  render();
})();
</script>
</body>
</html>
